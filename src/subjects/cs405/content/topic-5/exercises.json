[
  {
    "id": "cs405-ex-5-1",
    "subjectId": "cs405",
    "topicId": "cs405-topic-5",
    "title": "Build Serverless REST API",
    "difficulty": 3,
    "description": "Create a serverless REST API using AWS Lambda and API Gateway (or similar) with:\n\n1. CRUD endpoints for a resource\n2. DynamoDB for data storage\n3. Input validation\n4. Error handling\n5. Proper HTTP status codes\n\nUse Serverless Framework or SAM.",
    "starterCode": "# serverless.yml\n# TODO: Define service configuration\n\n# handler.py\n# TODO: Implement Lambda functions",
    "solution": "# serverless.yml\nservice: users-api\n\nprovider:\n  name: aws\n  runtime: python3.9\n  region: us-east-1\n  stage: ${opt:stage, 'dev'}\n  environment:\n    USERS_TABLE: ${self:service}-${self:provider.stage}-users\n    STAGE: ${self:provider.stage}\n  iam:\n    role:\n      statements:\n        - Effect: Allow\n          Action:\n            - dynamodb:Query\n            - dynamodb:Scan\n            - dynamodb:GetItem\n            - dynamodb:PutItem\n            - dynamodb:UpdateItem\n            - dynamodb:DeleteItem\n          Resource:\n            - !GetAtt UsersTable.Arn\n            - !Join ['/', [!GetAtt UsersTable.Arn, 'index', '*']]\n\nfunctions:\n  createUser:\n    handler: handler.create_user\n    events:\n      - http:\n          path: /users\n          method: post\n          cors: true\n\n  getUser:\n    handler: handler.get_user\n    events:\n      - http:\n          path: /users/{user_id}\n          method: get\n          cors: true\n\n  listUsers:\n    handler: handler.list_users\n    events:\n      - http:\n          path: /users\n          method: get\n          cors: true\n\n  updateUser:\n    handler: handler.update_user\n    events:\n      - http:\n          path: /users/{user_id}\n          method: put\n          cors: true\n\n  deleteUser:\n    handler: handler.delete_user\n    events:\n      - http:\n          path: /users/{user_id}\n          method: delete\n          cors: true\n\nresources:\n  Resources:\n    UsersTable:\n      Type: AWS::DynamoDB::Table\n      Properties:\n        TableName: ${self:provider.environment.USERS_TABLE}\n        AttributeDefinitions:\n          - AttributeName: user_id\n            AttributeType: S\n          - AttributeName: email\n            AttributeType: S\n        KeySchema:\n          - AttributeName: user_id\n            KeyType: HASH\n        GlobalSecondaryIndexes:\n          - IndexName: EmailIndex\n            KeySchema:\n              - AttributeName: email\n                KeyType: HASH\n            Projection:\n              ProjectionType: ALL\n            ProvisionedThroughput:\n              ReadCapacityUnits: 5\n              WriteCapacityUnits: 5\n        BillingMode: PROVISIONED\n        ProvisionedThroughput:\n          ReadCapacityUnits: 5\n          WriteCapacityUnits: 5\n\n# handler.py\nimport json\nimport os\nimport uuid\nfrom datetime import datetime\nimport boto3\nfrom boto3.dynamodb.conditions import Key\nfrom botocore.exceptions import ClientError\n\ndynamodb = boto3.resource('dynamodb')\ntable_name = os.environ['USERS_TABLE']\ntable = dynamodb.Table(table_name)\n\ndef response(status_code, body):\n    \"\"\"Helper function to create HTTP response\"\"\"\n    return {\n        'statusCode': status_code,\n        'headers': {\n            'Content-Type': 'application/json',\n            'Access-Control-Allow-Origin': '*',\n            'Access-Control-Allow-Credentials': True\n        },\n        'body': json.dumps(body)\n    }\n\ndef validate_user(data):\n    \"\"\"Validate user data\"\"\"\n    required_fields = ['name', 'email']\n    for field in required_fields:\n        if field not in data or not data[field]:\n            return False, f\"Missing required field: {field}\"\n\n    # Basic email validation\n    if '@' not in data['email']:\n        return False, \"Invalid email format\"\n\n    return True, None\n\ndef create_user(event, context):\n    \"\"\"Create a new user\"\"\"\n    try:\n        data = json.loads(event['body'])\n\n        # Validate input\n        is_valid, error_msg = validate_user(data)\n        if not is_valid:\n            return response(400, {'error': error_msg})\n\n        # Check if email already exists\n        existing = table.query(\n            IndexName='EmailIndex',\n            KeyConditionExpression=Key('email').eq(data['email'])\n        )\n        if existing['Items']:\n            return response(409, {'error': 'Email already exists'})\n\n        # Create user\n        user = {\n            'user_id': str(uuid.uuid4()),\n            'name': data['name'],\n            'email': data['email'],\n            'created_at': datetime.utcnow().isoformat(),\n            'updated_at': datetime.utcnow().isoformat()\n        }\n\n        table.put_item(Item=user)\n\n        return response(201, user)\n\n    except json.JSONDecodeError:\n        return response(400, {'error': 'Invalid JSON'})\n    except Exception as e:\n        print(f\"Error creating user: {str(e)}\")\n        return response(500, {'error': 'Internal server error'})\n\ndef get_user(event, context):\n    \"\"\"Get a single user by ID\"\"\"\n    try:\n        user_id = event['pathParameters']['user_id']\n\n        result = table.get_item(Key={'user_id': user_id})\n\n        if 'Item' not in result:\n            return response(404, {'error': 'User not found'})\n\n        return response(200, result['Item'])\n\n    except Exception as e:\n        print(f\"Error getting user: {str(e)}\")\n        return response(500, {'error': 'Internal server error'})\n\ndef list_users(event, context):\n    \"\"\"List all users with pagination\"\"\"\n    try:\n        # Get query parameters\n        params = event.get('queryStringParameters') or {}\n        limit = int(params.get('limit', 10))\n        last_key = params.get('last_key')\n\n        # Build scan parameters\n        scan_params = {'Limit': limit}\n        if last_key:\n            scan_params['ExclusiveStartKey'] = {'user_id': last_key}\n\n        result = table.scan(**scan_params)\n\n        response_body = {\n            'users': result['Items'],\n            'count': len(result['Items'])\n        }\n\n        if 'LastEvaluatedKey' in result:\n            response_body['last_key'] = result['LastEvaluatedKey']['user_id']\n\n        return response(200, response_body)\n\n    except Exception as e:\n        print(f\"Error listing users: {str(e)}\")\n        return response(500, {'error': 'Internal server error'})\n\ndef update_user(event, context):\n    \"\"\"Update an existing user\"\"\"\n    try:\n        user_id = event['pathParameters']['user_id']\n        data = json.loads(event['body'])\n\n        # Check if user exists\n        existing = table.get_item(Key={'user_id': user_id})\n        if 'Item' not in existing:\n            return response(404, {'error': 'User not found'})\n\n        # Build update expression\n        update_expr = \"SET updated_at = :updated_at\"\n        expr_values = {':updated_at': datetime.utcnow().isoformat()}\n\n        if 'name' in data:\n            update_expr += \", #n = :name\"\n            expr_values[':name'] = data['name']\n\n        if 'email' in data:\n            # Check if new email already exists\n            email_check = table.query(\n                IndexName='EmailIndex',\n                KeyConditionExpression=Key('email').eq(data['email'])\n            )\n            if email_check['Items'] and email_check['Items'][0]['user_id'] != user_id:\n                return response(409, {'error': 'Email already exists'})\n\n            update_expr += \", email = :email\"\n            expr_values[':email'] = data['email']\n\n        # Update user\n        result = table.update_item(\n            Key={'user_id': user_id},\n            UpdateExpression=update_expr,\n            ExpressionAttributeNames={'#n': 'name'} if 'name' in data else {},\n            ExpressionAttributeValues=expr_values,\n            ReturnValues='ALL_NEW'\n        )\n\n        return response(200, result['Attributes'])\n\n    except json.JSONDecodeError:\n        return response(400, {'error': 'Invalid JSON'})\n    except Exception as e:\n        print(f\"Error updating user: {str(e)}\")\n        return response(500, {'error': 'Internal server error'})\n\ndef delete_user(event, context):\n    \"\"\"Delete a user\"\"\"\n    try:\n        user_id = event['pathParameters']['user_id']\n\n        # Check if user exists\n        existing = table.get_item(Key={'user_id': user_id})\n        if 'Item' not in existing:\n            return response(404, {'error': 'User not found'})\n\n        table.delete_item(Key={'user_id': user_id})\n\n        return response(204, {})\n\n    except Exception as e:\n        print(f\"Error deleting user: {str(e)}\")\n        return response(500, {'error': 'Internal server error'})\n\n# requirements.txt\n# boto3==1.26.137\n# botocore==1.29.137",
    "hints": [
      "Use environment variables for table names",
      "Validate input before database operations",
      "Return appropriate HTTP status codes",
      "Use GSI for non-key queries",
      "Implement pagination for list operations"
    ],
    "testCases": [
      {
        "input": "POST /users {\"name\":\"John\",\"email\":\"john@test.com\"}",
        "expectedOutput": "201 Created with user object",
        "isHidden": false,
        "description": "Create a new user"
      },
      {
        "input": "GET /users/USER_ID",
        "expectedOutput": "200 OK with user details",
        "isHidden": false,
        "description": "Get user by ID"
      },
      {
        "input": "DELETE /users/USER_ID",
        "expectedOutput": "204 No Content",
        "isHidden": false,
        "description": "Delete a user"
      }
    ],
    "language": "python"
  }
]
