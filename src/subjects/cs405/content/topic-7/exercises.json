[
  {
    "id": "cs405-ex-7-1",
    "subjectId": "cs405",
    "topicId": "cs405-topic-7",
    "title": "Implement 12-Factor App",
    "difficulty": 3,
    "description": "Create a cloud-native application following 12-factor principles:\n\n1. Configuration via environment variables\n2. Stateless design\n3. Proper logging\n4. Graceful shutdown\n5. Health check endpoints\n6. Containerized deployment\n\nInclude Dockerfile and deployment manifests.",
    "starterCode": "# app.py\n# TODO: Implement 12-factor app\n\n# Dockerfile\n# TODO: Create Dockerfile\n\n# k8s/deployment.yaml\n# TODO: Create Kubernetes deployment",
    "solution": "# app.py\nimport os\nimport sys\nimport signal\nimport logging\nfrom flask import Flask, jsonify, request\nimport redis\nfrom datetime import datetime\n\n# Configure logging (Factor 11: Logs as event streams)\nlogging.basicConfig(\n    level=os.environ.get('LOG_LEVEL', 'INFO'),\n    format='{\"timestamp\":\"%(asctime)s\",\"level\":\"%(levelname)s\",\"message\":\"%(message)s\"}',\n    stream=sys.stdout\n)\nlogger = logging.getLogger(__name__)\n\napp = Flask(__name__)\n\n# Factor 3: Config in environment\nCONFIG = {\n    'REDIS_HOST': os.environ.get('REDIS_HOST', 'localhost'),\n    'REDIS_PORT': int(os.environ.get('REDIS_PORT', 6379)),\n    'PORT': int(os.environ.get('PORT', 8080)),\n    'WORKERS': int(os.environ.get('WORKERS', 4))\n}\n\n# Factor 4: Backing services as attached resources\nredis_client = None\n\ndef init_redis():\n    \"\"\"Initialize Redis connection\"\"\"\n    global redis_client\n    try:\n        redis_client = redis.Redis(\n            host=CONFIG['REDIS_HOST'],\n            port=CONFIG['REDIS_PORT'],\n            decode_responses=True,\n            socket_connect_timeout=5\n        )\n        redis_client.ping()\n        logger.info(f\"Connected to Redis at {CONFIG['REDIS_HOST']}:{CONFIG['REDIS_PORT']}\")\n    except Exception as e:\n        logger.error(f\"Failed to connect to Redis: {str(e)}\")\n        redis_client = None\n\n# Factor 9: Disposability (fast startup)\ninit_redis()\n\n# Health check endpoint\n@app.route('/health')\ndef health():\n    \"\"\"Health check endpoint\"\"\"\n    health_status = {\n        'status': 'healthy',\n        'timestamp': datetime.utcnow().isoformat(),\n        'redis': 'connected' if redis_client and redis_client.ping() else 'disconnected'\n    }\n    status_code = 200 if health_status['redis'] == 'connected' else 503\n    return jsonify(health_status), status_code\n\n# Readiness check\n@app.route('/ready')\ndef ready():\n    \"\"\"Readiness check endpoint\"\"\"\n    if redis_client and redis_client.ping():\n        return jsonify({'status': 'ready'}), 200\n    return jsonify({'status': 'not ready'}), 503\n\n# Factor 6: Stateless processes\n@app.route('/counter', methods=['GET', 'POST'])\ndef counter():\n    \"\"\"Stateless counter using Redis\"\"\"\n    if not redis_client:\n        return jsonify({'error': 'Redis not available'}), 503\n\n    if request.method == 'POST':\n        count = redis_client.incr('counter')\n        logger.info(f\"Counter incremented to {count}\")\n        return jsonify({'count': count}), 200\n    else:\n        count = redis_client.get('counter') or 0\n        return jsonify({'count': int(count)}), 200\n\n# Factor 9: Graceful shutdown\nshutdown_flag = False\n\ndef signal_handler(signum, frame):\n    \"\"\"Handle shutdown signals\"\"\"\n    global shutdown_flag\n    logger.info(f\"Received signal {signum}, initiating graceful shutdown...\")\n    shutdown_flag = True\n\n    # Close Redis connection\n    if redis_client:\n        redis_client.close()\n        logger.info(\"Redis connection closed\")\n\n    logger.info(\"Shutdown complete\")\n    sys.exit(0)\n\nsignal.signal(signal.SIGTERM, signal_handler)\nsignal.signal(signal.SIGINT, signal_handler)\n\nif __name__ == '__main__':\n    logger.info(f\"Starting application on port {CONFIG['PORT']}\")\n    # Factor 7: Port binding\n    app.run(\n        host='0.0.0.0',\n        port=CONFIG['PORT'],\n        debug=False\n    )\n\n# Dockerfile\nFROM python:3.11-slim as base\n\n# Factor 2: Dependencies explicitly declared\nWORKDIR /app\nCOPY requirements.txt .\nRUN pip install --no-cache-dir -r requirements.txt\n\n# Factor 5: Build, release, run (build stage)\nFROM python:3.11-slim\n\n# Install dumb-init for proper signal handling\nRUN apt-get update && \\\n    apt-get install -y --no-install-recommends dumb-init && \\\n    apt-get clean && \\\n    rm -rf /var/lib/apt/lists/*\n\n# Create non-root user\nRUN useradd -m -u 1000 appuser\n\nWORKDIR /app\n\n# Copy dependencies\nCOPY --from=base /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages\n\n# Copy application\nCOPY --chown=appuser:appuser app.py .\n\nUSER appuser\n\n# Factor 7: Port binding\nEXPOSE 8080\n\n# Factor 9: Disposability\nENTRYPOINT [\"dumb-init\", \"--\"]\nCMD [\"python\", \"app.py\"]\n\n# requirements.txt\nFlask==2.3.2\nredis==4.5.5\ngunicorn==20.1.0\n\n# k8s/deployment.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: app-config\ndata:\n  LOG_LEVEL: \"INFO\"\n  WORKERS: \"4\"\n\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: cloud-native-app\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: cloud-native-app\n  template:\n    metadata:\n      labels:\n        app: cloud-native-app\n    spec:\n      containers:\n      - name: app\n        image: cloud-native-app:1.0\n        ports:\n        - containerPort: 8080\n        env:\n        # Factor 3: Config from environment\n        - name: PORT\n          value: \"8080\"\n        - name: REDIS_HOST\n          value: redis\n        - name: REDIS_PORT\n          value: \"6379\"\n        - name: LOG_LEVEL\n          valueFrom:\n            configMapKeyRef:\n              name: app-config\n              key: LOG_LEVEL\n        # Factor 10: Dev/prod parity\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 8080\n          initialDelaySeconds: 10\n          periodSeconds: 10\n        readinessProbe:\n          httpGet:\n            path: /ready\n            port: 8080\n          initialDelaySeconds: 5\n          periodSeconds: 5\n        resources:\n          requests:\n            memory: \"128Mi\"\n            cpu: \"100m\"\n          limits:\n            memory: \"256Mi\"\n            cpu: \"500m\"\n        # Factor 9: Fast shutdown\n        lifecycle:\n          preStop:\n            exec:\n              command: [\"sleep\", \"5\"]\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: cloud-native-app\nspec:\n  selector:\n    app: cloud-native-app\n  ports:\n  - port: 80\n    targetPort: 8080\n\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: redis\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: redis\n  template:\n    metadata:\n      labels:\n        app: redis\n    spec:\n      containers:\n      - name: redis\n        image: redis:7-alpine\n        ports:\n        - containerPort: 6379\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: redis\nspec:\n  selector:\n    app: redis\n  ports:\n  - port: 6379\n    targetPort: 6379",
    "hints": [
      "Use environment variables for all configuration",
      "Design stateless processes",
      "Implement graceful shutdown",
      "Log to stdout/stderr",
      "Fast startup and shutdown"
    ],
    "testCases": [
      {
        "input": "curl /health",
        "expectedOutput": "200 OK with health status",
        "isHidden": false,
        "description": "Test health check endpoint"
      },
      {
        "input": "SIGTERM signal",
        "expectedOutput": "Graceful shutdown within 5 seconds",
        "isHidden": false,
        "description": "Verify graceful shutdown handling"
      }
    ],
    "language": "python"
  }
]
